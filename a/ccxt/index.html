<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCXT Exchange Screener</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>

<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container-fluid">
                <span class="navbar-brand">
                    <i class="fas fa-chart-line"></i>Exchange Screener
                </span>
                <div class="d-flex align-items-center gap-2">
                    <input 
                        type="text" 
                        v-model="symbolFilter" 
                        placeholder="Filter symbols"
                        class="form-control form-control-sm filter-input">
                </div>
            </div>
        </nav>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Sidebar - Exchange List -->
            <div class="left-sidebar" :class="{ 'collapsed': !showExchanges }">
                <div class="sidebar-header">
                    <h6 class="sidebar-title" v-show="showExchanges">
                        <i class="fas fa-exchange-alt"></i> Exchanges
                    </h6>
                    <button class="toggle-sidebar-btn" @click="toggleExchanges" :title="showExchanges ? 'Collapse' : 'Expand'">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Collapsed Exchange Buttons -->
                <div class="exchange-buttons-collapsed" v-show="!showExchanges">
                    <button v-for="exchange in exchanges" :key="'btn-' + exchange.id"
                            class="exchange-btn-icon"
                            :class="{ 
                                'active': activeTab === exchange.id,
                                'running': exchange.status === 'running',
                                'cycle-completed': exchange.cycleCompleted
                            }"
                            @click="activeTab = exchange.id"
                            :title="exchange.name">
                        {{ getExchangeInitial(exchange.name) }}
                    </button>
                </div>
                
                <div class="exchange-cards">
                    <div v-for="exchange in exchanges" :key="exchange.id" 
                         class="exchange-card" 
                         :class="{ 
                             'cycle-completed': exchange.cycleCompleted,
                             'active': activeTab === exchange.id
                         }"
                         @click="activeTab = exchange.id">
                        <div class="exchange-header">
                            <div class="exchange-name">
                                <strong>{{ exchange.name }}</strong>
                                <span class="status-badge" :class="exchange.status">{{ exchange.status }}</span>
                            </div>
                            <div class="exchange-stats">
                                <span class="stat-item" @click="showSymbols(exchange)" title="Total Symbols">
                                    <i class="fas fa-list"></i> {{ exchange.symbolCount }}
                                </span>
                                <span class="stat-item" title="Processed">
                                    <i class="fas fa-check-circle"></i> {{ exchange.processedCount }}
                                </span>
                            </div>
                        </div>
                        <div class="exchange-meta">
                            <span class="meta-item">Cycles: {{ exchange.cycleCount }}</span>
                            <span class="meta-item">Q: {{ exchange.queueLength }}</span>
                            <span class="meta-item">{{ exchange.requestCount }}/min</span>
                        </div>
                        <div class="exchange-controls">
                            <button class="btn-control btn-start" @click="startExchange(exchange.id)"
                                :disabled="exchange.status === 'running'" title="Start">
                                <i class="fas fa-play"></i>
                            </button>
                            <button class="btn-control btn-pause" @click="pauseExchange(exchange.id)"
                                :disabled="exchange.status !== 'running'" title="Pause">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button class="btn-control btn-stop" @click="stopExchange(exchange.id)"
                                :disabled="exchange.status === 'stopped'" title="Stop">
                                <i class="fas fa-stop"></i>
                            </button>
                            <button class="btn-control btn-reload" @click="reloadExchange(exchange.id)" title="Reload">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content - Results Table -->
            <div class="main-content">
                <div class="tab-content">
                    <div v-for="exchange in exchanges" :key="exchange.id" 
                        class="tab-pane"
                        :style="{ display: activeTab === exchange.id ? 'block' : 'none' }">
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th class="th-symbol"><i class="fas fa-coins"></i> Symbol</th>
                                        <th class="th-price sortable" @click="sortTable(exchange.id, 'price')">
                                            <i class="fas fa-dollar-sign"></i> Price
                                            <i :class="getSortIcon(exchange.id, 'price')" class="sort-icon"></i>
                                        </th>
                                        <th class="th-change sortable" @click="sortTable(exchange.id, 'change')">
                                            <i class="fas fa-chart-line"></i> Change
                                            <i :class="getSortIcon(exchange.id, 'change')" class="sort-icon"></i>
                                        </th>
                                        <th class="th-high"><i class="fas fa-arrow-up"></i> High</th>
                                        <th class="th-low"><i class="fas fa-arrow-down"></i> Low</th>
                                        <th class="th-volume sortable" @click="sortTable(exchange.id, 'volume')">
                                            <i class="fas fa-chart-bar"></i> Vol (USDT)
                                            <i :class="getSortIcon(exchange.id, 'volume')" class="sort-icon"></i>
                                        </th>
                                        <th class="th-time"><i class="fas fa-clock"></i> Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-if="getFilteredResults(exchange.id).length === 0">
                                        <td colspan="7" class="no-data">
                                            <i class="fas fa-inbox fa-2x" style="opacity: 0.3; margin-bottom: 10px;"></i>
                                            <div>{{ symbolFilter ? 'No matching symbols found.' : 'No data yet. Click Start to begin fetching.' }}</div>
                                        </td>
                                    </tr>
                                    <tr v-for="result in getFilteredResults(exchange.id)" :key="result.symbol" 
                                        :class="{ 'row-updated': result.updated }">
                                        <td class="symbol-cell">
                                            <img :src="getCoinIcon(result.symbol)" 
                                                 :alt="result.symbol.split('/')[0]"
                                                 class="coin-icon"
                                                 @error="handleIconError">
                                            <a :href="getChartLink(result.symbol, exchange.id)" 
                                               class="symbol-link"
                                               target="_blank"
                                               :title="'Open ' + result.symbol + ' chart'">
                                                <div class="symbol-info">
                                                    <span class="symbol-name">{{ result.symbol.split('/')[0] }}</span>
                                                </div>
                                            </a>
                                        </td>
                                        <td class="price-cell">
                                            <span class="price-value">{{ formatPrice(result.close) }}</span>
                                        </td>
                                        <td class="change-cell" :class="getPriceChangeClass(result)">
                                            <i :class="getPriceChangeIcon(result)"></i>
                                            <span>{{ calculateChange(result) }}</span>
                                        </td>
                                        <td class="high-cell">{{ formatPrice(result.high) }}</td>
                                        <td class="low-cell">{{ formatPrice(result.low) }}</td>
                                        <td class="volume-cell">
                                            {{ formatVolume(result.volume) }}
                                        </td>
                                        <td class="time-cell">
                                         
                                            {{ formatTime(result.timestamp) }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Modal -->
            <div v-if="showSettingsModal" class="modal-backdrop" @click="closeSettings">
                <div class="modal-dialog modal-lg" @click.stop>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-cog"></i> Settings</h5>
                            <button type="button" class="btn-close" @click="closeSettings">Ã—</button>
                        </div>
                        <div class="modal-body settings-body">
                            <!-- Rate Limiting Settings -->
                            <div class="settings-section">
                                <h6 class="settings-section-title">
                                    <i class="fas fa-tachometer-alt"></i> Rate Limiting
                                </h6>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label>Requests Per Minute</label>
                                        <input type="number" v-model="settings.requestsPerMinute" class="setting-input" min="10" max="1000">
                                        <small>Number of API requests per minute per exchange</small>
                                    </div>
                                    <div class="setting-item">
                                        <label>Symbols Per Batch</label>
                                        <input type="number" v-model="settings.symbolsPerBatch" class="setting-input" min="1" max="50">
                                        <small>Number of symbols to process in each batch</small>
                                    </div>
                                </div>
                            </div>

                            <!-- OHLCV Settings -->
                            <div class="settings-section">
                                <h6 class="settings-section-title">
                                    <i class="fas fa-chart-candlestick"></i> OHLCV Data
                                </h6>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label>OHLCV Limit</label>
                                        <input type="number" v-model="settings.ohlcvLimit" class="setting-input" min="100" max="5000">
                                        <small>Number of candles to fetch per symbol</small>
                                    </div>
                                    <div class="setting-item">
                                        <label>Default Timeframe</label>
                                        <select v-model="settings.defaultTimeframe" class="setting-input">
                                            <option value="1m">1 minute</option>
                                            <option value="5m">5 minutes</option>
                                            <option value="15m">15 minutes</option>
                                            <option value="1h">1 hour</option>
                                            <option value="4h">4 hours</option>
                                            <option value="1d">1 day</option>
                                        </select>
                                        <small>Default timeframe for OHLCV data</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Cache Settings -->
                            <div class="settings-section">
                                <h6 class="settings-section-title">
                                    <i class="fas fa-database"></i> Cache
                                </h6>
                                <div class="settings-grid">
                                    <div class="setting-item">
                                        <label>Cache Expiry (hours)</label>
                                        <input type="number" v-model="settings.cacheExpiry" class="setting-input" min="1" max="168">
                                        <small>How long to cache market data (in hours)</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Exchange Toggle -->
                            <div class="settings-section">
                                <h6 class="settings-section-title">
                                    <i class="fas fa-exchange-alt"></i> Enabled Exchanges
                                </h6>
                                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">
                                    <i class="fas fa-info-circle"></i> Toggle exchanges on/off. Changes will be saved and applied on next page load.
                                </p>
                                <div class="exchange-toggles">
                                    <div v-for="(enabled, id) in enabledExchanges" :key="id" class="exchange-toggle">
                                        <label class="toggle-label">
                                            <input type="checkbox" v-model="enabledExchanges[id]" class="toggle-checkbox">
                                            <span class="toggle-slider"></span>
                                            <span class="toggle-text">{{ getExchangeName(id) }}</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-modal btn-cancel" @click="closeSettings">Cancel</button>
                            <button class="btn-modal btn-save" @click="saveSettings">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Symbols Modal -->
            <div v-if="showSymbolsModal" class="modal-backdrop" @click="closeModal">
                <div class="modal-dialog" @click.stop>
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">{{ selectedExchange ? selectedExchange.name : '' }} - Symbols</h5>
                            <button type="button" class="btn-close" @click="closeModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="modal-search">
                                <i class="fas fa-search"></i>
                                <input type="text" v-model="modalSymbolFilter" placeholder="Search symbols..." class="modal-search-input">
                            </div>
                            <div class="symbols-grid">
                                <div v-for="(symbol, index) in getFilteredModalSymbols()" :key="symbol" class="symbol-item">
                                    <span class="symbol-index">{{ index + 1 }}</span>
                                    <span class="symbol-text">
                                        <i class="fas fa-circle symbol-dot"></i>
                                        {{ symbol }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - Controls & Logs -->
            <div class="right-sidebar" :class="{ 'collapsed': !showLogs }">
                <div class="sidebar-header">
                    <h6 class="sidebar-title" v-show="showLogs">
                        <i class="fas fa-sliders-h"></i> Controls
                    </h6>
                    <button class="toggle-logs-btn" @click="toggleLogs" :title="showLogs ? 'Collapse' : 'Expand'">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                
                <!-- Control Buttons -->
                <div class="control-buttons" v-show="showLogs">
                    <button class="control-btn btn-start-all" @click="startAll">
                        <i class="fas fa-play-circle"></i>
                        <span>Start All</span>
                    </button>
                    <button class="control-btn btn-pause-all" @click="pauseAll">
                        <i class="fas fa-pause-circle"></i>
                        <span>Pause All</span>
                    </button>
                    <button class="control-btn btn-stop-all" @click="stopAll">
                        <i class="fas fa-stop-circle"></i>
                        <span>Stop All</span>
                    </button>
                    <button class="control-btn btn-clear-cache" @click="clearCache">
                        <i class="fas fa-trash-alt"></i>
                        <span>Clear Cache</span>
                    </button>
                    <button class="control-btn btn-settings" @click="openSettings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </button>
                </div>

                <!-- Collapsed Control Buttons -->
                <div class="control-buttons-collapsed" v-show="!showLogs">
                    <button class="control-btn-icon btn-start-all" @click="startAll" title="Start All">
                        <i class="fas fa-play-circle"></i>
                    </button>
                    <button class="control-btn-icon btn-pause-all" @click="pauseAll" title="Pause All">
                        <i class="fas fa-pause-circle"></i>
                    </button>
                    <button class="control-btn-icon btn-stop-all" @click="stopAll" title="Stop All">
                        <i class="fas fa-stop-circle"></i>
                    </button>
                    <button class="control-btn-icon btn-clear-cache" @click="clearCache" title="Clear Cache">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button class="control-btn-icon btn-settings" @click="openSettings" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                
                <!-- Logs Section -->
                <div class="logs-section" v-show="showLogs">
                    <div class="logs-header">
                        <i class="fas fa-terminal"></i> Logs
                    </div>
                    <div class="logs-container">
                        <div v-for="(log, index) in logs" :key="index" class="log-entry" :class="log.type">
                            <small class="log-time">{{ log.time }}</small>
                            <span class="log-message">{{ log.message }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div v-if="loading" class="loading-overlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <div class="loading-message">{{ loadingMessage }}</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
    <script src="dayjs.min.js"></script>
    <script src="lodash.min.js"></script>
    <script src="ccxt.browser.min.js"></script>
    
    <script src="js/config.js"></script>
    <script src="js/Logger.js"></script>
    <script src="js/Database.js"></script>
    <script src="js/RateLimiter.js"></script>
    <script src="js/Analyzer.js"></script>
    <script src="js/BaseExchange.js"></script>
    <script src="exchanges/binance.js"></script>
    <script src="exchanges/bybit.js"></script>
    <script src="exchanges/okx.js"></script>
    <script src="exchanges/bingx.js"></script>
    <script src="exchanges/ascendex.js"></script>
    <script src="exchanges/bitmart.js"></script>
    <script src="exchanges/mexc.js"></script>
    <script src="exchanges/phemex.js"></script>
    <script src="exchanges/xt.js"></script>
    <script src="exchanges/kucoin.js"></script>
    <script src="js/ExchangeManager.js"></script>
    <script src="js/app.js"></script>
</body>

</html>