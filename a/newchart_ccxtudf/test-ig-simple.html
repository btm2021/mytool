<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IG Simple Test - XAUUSD</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #4ec9b0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #2d2d30;
            border-left: 4px solid #569cd6;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #1177bb;
        }
        .price-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .price-card {
            background: #2d2d30;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #569cd6;
        }
        .price-card h3 {
            margin: 0 0 10px 0;
            color: #4ec9b0;
            font-size: 14px;
        }
        .price-value {
            font-size: 24px;
            font-weight: bold;
            color: #dcdcaa;
        }
        #log {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• IG Simple Test - XAUUSD (Gold)</h1>
        
        <div class="status" id="status">
            Status: Ready
        </div>

        <div>
            <button onclick="testAuth()">1. Test Authentication</button>
            <button onclick="testMarket()">2. Test Market Data</button>
            <button onclick="testPrices()">3. Test Historical Prices</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="price-display">
            <div class="price-card">
                <h3>BID</h3>
                <div class="price-value" id="bid">--</div>
            </div>
            <div class="price-card">
                <h3>ASK</h3>
                <div class="price-value" id="ask">--</div>
            </div>
            <div class="price-card">
                <h3>MID</h3>
                <div class="price-value" id="mid">--</div>
            </div>
            <div class="price-card">
                <h3>SPREAD</h3>
                <div class="price-value" id="spread">--</div>
            </div>
        </div>

        <h3>Log</h3>
        <div id="log"></div>
    </div>

    <script>
        const IG_CONFIG = {
            apiKey: 'ce5bf388c563a2de5592c20a318752219d158e74',
            username: 'trinhminhbao',
            password: 'anhBAO@1991',
            demo: true
        };

        const apiUrl = 'https://demo-api.ig.com/gateway/deal';
        const epic = 'CS.D.CFPGOLD.CFP.IP'; // XAUUSD

        let cst = null;
        let securityToken = null;
        let accountId = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${time}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = 'Status: ' + message;
        }

        async function testAuth() {
            log('=== Testing Authentication ===');
            updateStatus('Authenticating...');

            try {
                const response = await fetch(`${apiUrl}/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json; charset=UTF-8',
                        'VERSION': '2',
                        'X-IG-API-KEY': IG_CONFIG.apiKey
                    },
                    body: JSON.stringify({
                        identifier: IG_CONFIG.username,
                        password: IG_CONFIG.password
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Authentication failed: ${response.status}`);
                    log(errorText);
                    updateStatus('Authentication failed');
                    return;
                }

                cst = response.headers.get('CST');
                securityToken = response.headers.get('X-SECURITY-TOKEN');
                
                const data = await response.json();
                accountId = data.currentAccountId;

                log(`‚úÖ Authentication successful`);
                log(`Account ID: ${accountId}`);
                log(`CST: ${cst.substring(0, 30)}...`);
                log(`Security Token: ${securityToken.substring(0, 30)}...`);
                updateStatus('Authenticated');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateStatus('Error');
            }
        }

        function getHeaders(version = '1') {
            return {
                'Content-Type': 'application/json',
                'Accept': 'application/json; charset=UTF-8',
                'VERSION': version,
                'X-IG-API-KEY': IG_CONFIG.apiKey,
                'CST': cst,
                'X-SECURITY-TOKEN': securityToken
            };
        }

        async function testMarket() {
            if (!cst) {
                log('‚ùå Please authenticate first (click button 1)');
                return;
            }

            log('\n=== Testing Market Data ===');
            updateStatus('Fetching market data...');

            try {
                const response = await fetch(`${apiUrl}/markets/${epic}`, {
                    headers: getHeaders('3')
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Market fetch failed: ${response.status}`);
                    log(errorText);
                    return;
                }

                const data = await response.json();
                log(`‚úÖ Market data received`);
                log(`Instrument: ${data.instrument.name}`);
                log(`Epic: ${data.instrument.epic}`);
                log(`Type: ${data.instrument.type}`);
                
                if (data.snapshot) {
                    const bid = data.snapshot.bid;
                    const offer = data.snapshot.offer;
                    const mid = (bid + offer) / 2;
                    const spread = offer - bid;

                    log(`\nCurrent Prices:`);
                    log(`BID: ${bid}`);
                    log(`ASK: ${offer}`);
                    log(`MID: ${mid.toFixed(2)}`);
                    log(`SPREAD: ${spread.toFixed(2)}`);

                    document.getElementById('bid').textContent = bid.toFixed(2);
                    document.getElementById('ask').textContent = offer.toFixed(2);
                    document.getElementById('mid').textContent = mid.toFixed(2);
                    document.getElementById('spread').textContent = spread.toFixed(2);

                    updateStatus('Market data loaded');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateStatus('Error');
            }
        }

        async function testPrices() {
            if (!cst) {
                log('‚ùå Please authenticate first (click button 1)');
                return;
            }

            log('\n=== Testing Historical Prices ===');
            updateStatus('Fetching historical prices...');

            try {
                const toDate = new Date();
                const fromDate = new Date(toDate.getTime() - (7 * 24 * 60 * 60 * 1000)); // 7 days ago

                const url = `${apiUrl}/prices/${epic}?resolution=MINUTE_15&from=${fromDate.toISOString()}&to=${toDate.toISOString()}`;
                
                log(`Fetching: ${url}`);

                const response = await fetch(url, {
                    headers: getHeaders('3')
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Prices fetch failed: ${response.status}`);
                    log(errorText);
                    return;
                }

                const data = await response.json();
                
                if (!data.prices || data.prices.length === 0) {
                    log('‚ùå No price data returned');
                    return;
                }

                log(`‚úÖ Received ${data.prices.length} candles`);
                
                // Show first 3 candles
                log('\nFirst 3 candles:');
                data.prices.slice(0, 3).forEach((price, i) => {
                    const time = price.snapshotTime || price.snapshotTimeUTC;
                    const open = (price.openPrice.bid + price.openPrice.ask) / 2;
                    const close = (price.closePrice.bid + price.closePrice.ask) / 2;
                    log(`${i + 1}. ${time} | O:${open.toFixed(2)} C:${close.toFixed(2)}`);
                });

                // Show last 3 candles
                log('\nLast 3 candles:');
                data.prices.slice(-3).forEach((price, i) => {
                    const time = price.snapshotTime || price.snapshotTimeUTC;
                    const open = (price.openPrice.bid + price.openPrice.ask) / 2;
                    const close = (price.closePrice.bid + price.closePrice.ask) / 2;
                    log(`${data.prices.length - 2 + i}. ${time} | O:${open.toFixed(2)} C:${close.toFixed(2)}`);
                });

                updateStatus('Historical prices loaded');

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateStatus('Error');
            }
        }

        // Initial log
        log('üéØ IG Simple Test initialized');
        log('üìç Epic: CS.D.CFPGOLD.CFP.IP (XAUUSD - Gold)');
        log('Click buttons in order: 1 ‚Üí 2 ‚Üí 3');
    </script>
</body>
</html>
