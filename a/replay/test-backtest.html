<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Backtest Logic</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
            background: #222;
        }
        .entry {
            margin: 5px 0;
            padding: 5px;
            background: #2a2a2a;
        }
        .long { color: #00ff00; }
        .short { color: #ff0000; }
        .positive { color: #00ff00; }
        .negative { color: #ff0000; }
    </style>
</head>
<body>
    <h1>Backtest Logic Test</h1>
    <button onclick="runTest()">Run Test</button>
    <div id="results"></div>

    <script src="simple-backtest.js"></script>
    <script>
        function generateTestData() {
            // Generate simple test data with clear trends
            const candles = [];
            let time = Math.floor(Date.now() / 1000) - 10000;
            let price = 100;
            
            // Uptrend for LONG signal
            for (let i = 0; i < 20; i++) {
                const open = price;
                price += Math.random() * 2; // Rising trend
                const close = price;
                const high = Math.max(open, close) + Math.random();
                const low = Math.min(open, close) - Math.random();
                
                candles.push({
                    time: time,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: 1000
                });
                time += 60;
            }
            
            // Downtrend for SHORT signal
            for (let i = 0; i < 20; i++) {
                const open = price;
                price -= Math.random() * 2; // Falling trend
                const close = price;
                const high = Math.max(open, close) + Math.random();
                const low = Math.min(open, close) - Math.random();
                
                candles.push({
                    time: time,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: 1000
                });
                time += 60;
            }
            
            // Another uptrend
            for (let i = 0; i < 20; i++) {
                const open = price;
                price += Math.random() * 1.5;
                const close = price;
                const high = Math.max(open, close) + Math.random();
                const low = Math.min(open, close) - Math.random();
                
                candles.push({
                    time: time,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: 1000
                });
                time += 60;
            }
            
            return candles;
        }
        
        function runTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">Running test...</div>';
            
            try {
                // Generate test data
                const testData = generateTestData();
                console.log('Test data:', testData.length, 'candles');
                console.log('Price range:', testData[0].close, 'to', testData[testData.length-1].close);
                
                // Run backtest
                const backtest = new SimpleBacktestSystem();
                const results = backtest.runBacktest(testData);
                
                console.log('Backtest results:', results);
                
                // Display results
                let html = '<div class="result">';
                html += `<h2>Results Summary</h2>`;
                html += `<p>Total Candles: ${results.totalCandles}</p>`;
                html += `<p>Total Signals: ${results.signals.length}</p>`;
                html += `<p>Total Entries: ${results.entries.length}</p>`;
                html += '</div>';
                
                // Display each entry
                results.entries.forEach((entry, i) => {
                    const pnlClass = entry.pnl >= 0 ? 'positive' : 'negative';
                    html += `<div class="entry">`;
                    html += `<h3>Entry ${i + 1}: <span class="${entry.side.toLowerCase()}">${entry.side}</span></h3>`;
                    html += `<p>Entry Price: ${entry.entryPrice.toFixed(4)}</p>`;
                    html += `<p>Exit Price: ${entry.exitPrice ? entry.exitPrice.toFixed(4) : 'N/A'}</p>`;
                    html += `<p>PnL: <span class="${pnlClass}">${entry.pnl ? entry.pnl.toFixed(2) : 'N/A'} USDT (${entry.pnlPercent ? entry.pnlPercent.toFixed(2) : 'N/A'}%)</span></p>`;
                    html += `<p>Max PnL: ${entry.maxPnL.toFixed(2)} USDT (${entry.maxPnLPercent.toFixed(2)}%)</p>`;
                    html += `<p>Min PnL: ${entry.minPnL.toFixed(2)} USDT (${entry.minPnLPercent.toFixed(2)}%)</p>`;
                    html += `<p>Candles: ${entry.candleData.length}</p>`;
                    html += '</div>';
                });
                
                // Statistics
                const stats = backtest.getStatistics();
                html += '<div class="result">';
                html += `<h2>Statistics</h2>`;
                html += `<p>Win Rate: ${stats.winRate.toFixed(2)}%</p>`;
                html += `<p>Total PnL: ${stats.totalPnL.toFixed(2)} USDT</p>`;
                html += `<p>Average PnL: ${stats.averagePnL.toFixed(2)} USDT</p>`;
                html += '</div>';
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Test error:', error);
                resultsDiv.innerHTML = `<div class="result" style="color: red;">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
