<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Chart Replay</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
</head>

<body>
    <div class="navbar">
        <div class="nav-group data-controls">
            <label>Symbol:</label>
            <button id="symbolSelector" class="symbol-selector-btn">
                <span id="selectedSymbol">Select Symbol</span>
                <span class="dropdown-arrow">▼</span>
            </button>
            <label>Timeframe:</label>
            <select id="timeframe">
                <option value="1m">1m</option>
                <option value="5m">5m</option>
                <option value="15m" selected>15m</option>
                <option value="1h">1h</option>
            </select>
            <label>Candles:</label>
            <input type="number" id="candleCount" value="10000" min="100" placeholder="Nến">
            <button id="loadData">Load Data</button>
        </div>
        
        <div class="nav-group replay-controls">
            <button id="replayBtn">Replay</button>
            <button id="playPauseBtn" disabled>Play</button>
            <button id="stepBtn" disabled>Step</button>
            <div class="speed-controls">
                <button class="speed-btn active" data-speed="5">5x</button>
                <button class="speed-btn" data-speed="10">10x</button>
                <button class="speed-btn" data-speed="50">50x</button>
            </div>
        </div>
        
        <div class="nav-group backtest-controls">
            <button id="clearBacktestBtn">Clear</button>
            <button id="cacheManagerBtn">Cache</button>
            <button id="indicatorSettingsBtn">Settings</button>
        </div>
        
        <div class="nav-group status-info">
            <span id="status">Ready</span>
            <span id="progress"></span>

        </div>
    </div>

    <div class="content">
        <div class="main-layout">
            <!-- Chart Section - 75% width -->
            <div class="chart-section">
                <div id="chart"></div>
            </div>

            <!-- Table Section - 25% width -->
            <div class="table-section">
                <div id="backtest-results" class="backtest-panel">
                    <div class="table-container">
                        <div class="table-header">
                            <span>Lệnh Giao Dịch</span>
                            <div class="table-controls">
                                <button id="exportTableBtn">CSV</button>
                                <button id="sortTableBtn">Sort</button>
                                <span id="tableRowCount">0</span>
                            </div>
                        </div>
                        <div class="table-wrapper">
                            <table id="backtest-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Side</th>
                                        <th>Entry</th>
                                        <th>Max Price</th>
                                        <th>Max PnL</th>
                                        <th>Max %</th>
                                    </tr>
                                </thead>
                                <tbody id="backtest-table-body">
                                </tbody>
                            </table>
                        </div>
                        <!-- Statistics moved to bottom -->
                        <div class="table-stats">
                            <div id="backtest-stats"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Manager Modal -->
    <div id="cacheModal" class="modal" style="display: none;">
        <div class="modal-content cache-modal">
            <div class="modal-header">
                <span class="modal-title">Cache Manager</span>
                <span class="modal-close cache-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="cache-stats">
                    <div class="cache-stat-item">
                        <span class="cache-stat-label">Total Symbols:</span>
                        <span id="cache-total-symbols" class="cache-stat-value">0</span>
                    </div>
                    <div class="cache-stat-item">
                        <span class="cache-stat-label">Total Candles:</span>
                        <span id="cache-total-candles" class="cache-stat-value">0</span>
                    </div>
                    <div class="cache-stat-item">
                        <span class="cache-stat-label">Storage Used:</span>
                        <span id="cache-storage-size" class="cache-stat-value">0 MB</span>
                    </div>
                </div>
                
                <div class="cache-controls">
                    <button id="refreshCacheBtn">Refresh</button>
                    <button id="clearAllCacheBtn">Clear All</button>
                </div>
                
                <div class="cache-table-container">
                    <table id="cache-table">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Timeframe</th>
                                <th>Candles</th>
                                <th>Last Update</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="cache-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Entry Detail Modal -->
    <div id="entryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Entry Detail</span>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="entry-info">
                    <div class="entry-info-item">
                        <span class="info-label">Side:</span>
                        <span id="modal-side" class="info-value"></span>
                    </div>
                    <div class="entry-info-item">
                        <span class="info-label">Entry:</span>
                        <span id="modal-entry-price" class="info-value"></span>
                    </div>
                    <div class="entry-info-item">
                        <span class="info-label">Exit:</span>
                        <span id="modal-exit-price" class="info-value"></span>
                    </div>
                    <div class="entry-info-item">
                        <span class="info-label">PnL:</span>
                        <span id="modal-pnl" class="info-value"></span>
                    </div>
                    <div class="entry-info-item">
                        <span class="info-label">Duration:</span>
                        <span id="modal-duration" class="info-value"></span>
                    </div>
                </div>
                
                <div class="profit-analysis">
                    <div class="analysis-header">Phân Tích Lợi Nhuận Tối Đa</div>
                    <div class="analysis-content">
                        <div class="analysis-item">
                            <span class="analysis-label">Giá cao nhất:</span>
                            <span id="analysis-max-price" class="analysis-value"></span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-label">PnL tối đa:</span>
                            <span id="analysis-max-pnl" class="analysis-value"></span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-label">ROE tối đa:</span>
                            <span id="analysis-max-roe" class="analysis-value"></span>
                        </div>
                        <div class="analysis-item">
                            <span class="analysis-label">Thời điểm:</span>
                            <span id="analysis-max-time" class="analysis-value"></span>
                        </div>
                    </div>
                </div>
                
                <div id="modal-chart"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading...</div>
            <div class="loading-progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <div class="progress-text">0%</div>
            </div>
        </div>
    </div>

    <!-- Symbol Selection Modal -->
    <div id="symbolModal" class="modal" style="display: none;">
        <div class="modal-content symbol-modal">
            <div class="modal-header">
                <span class="modal-title">Select Symbol</span>
                <span class="modal-close symbol-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="symbol-search-container">
                    <input type="text" id="symbolSearch" placeholder="Search symbols..." class="symbol-search">
                </div>
                <div class="symbol-table-container">
                    <table id="symbol-table">
                        <thead>
                            <tr>
                                <th class="favorite-header">★</th>
                                <th data-sort="symbol" class="sortable">Symbol <span class="sort-indicator"></span></th>
                                <th data-sort="lastPrice" class="sortable">Last Price <span class="sort-indicator"></span></th>
                                <th data-sort="quoteVolume" class="sortable">Volume (USDT) <span class="sort-indicator"></span></th>
                                <th data-sort="priceChangePercent" class="sortable">Change % <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="symbol-table-body">
                            <tr><td colspan="5" class="loading-row">Loading symbols...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicator Settings Modal -->
    <div id="indicatorSettingsModal" class="modal" style="display: none;">
        <div class="modal-content settings-modal">
            <div class="modal-header">
                <span class="modal-title">Indicator Settings</span>
                <span class="modal-close settings-modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Bot ATR Settings</h3>
                    <div class="setting-group">
                        <label for="bot-ema-length">EMA Length:</label>
                        <input type="number" id="bot-ema-length" value="30" min="1" max="200">
                    </div>
                    <div class="setting-group">
                        <label for="bot-atr-length">ATR Length:</label>
                        <input type="number" id="bot-atr-length" value="14" min="1" max="100">
                    </div>
                    <div class="setting-group">
                        <label for="bot-atr-multiplier">ATR Multiplier:</label>
                        <input type="number" id="bot-atr-multiplier" value="2.0" min="0.1" max="10" step="0.1">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>VSR Settings</h3>
                    <div class="setting-group">
                        <label for="vsr-length">Length:</label>
                        <input type="number" id="vsr-length" value="10" min="1" max="100">
                    </div>
                    <div class="setting-group">
                        <label for="vsr-threshold">Threshold:</label>
                        <input type="number" id="vsr-threshold" value="10" min="1" max="100">
                    </div>
                </div>
                
                <div class="settings-controls">
                    <button id="resetSettingsBtn">Reset to Default</button>
                    <button id="applySettingsBtn">Apply Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script src="binance-api.js"></script>
    <script src="symbol-selector.js"></script>
    <script src="botatr.js"></script>
    <script src="vsr-indicator.js"></script>
    <script src="chart-manager.js"></script>
    <script src="replay-engine.js"></script>
    <script src="backtest-engine.js"></script>
    <script src="cache-manager.js"></script>
    <script src="app.js"></script>
</body>

</html>