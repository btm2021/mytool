<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading Event Logger</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- BootstrapVue CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.css" rel="stylesheet">
  <!-- PocketBase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.js"></script>
  <link rel="stylesheet" href="styles.css" />
  <style>

  </style>
</head>

<body>
  <div id="app">
    <!-- Header -->
    <div class="header">
      <span>TRADING EVENT LOGGER</span>
      <span class="header-status">{{ connectionStatus }}</span>
    </div>

    <!-- Main Container -->
    <div class="main-container">
      <!-- Left Panel: Tabs -->
      <div class="left-panel">
        <!-- Tab Navigation -->
        <div class="tab-section">
          <button class="tab-btn" :class="{ active: activeTab === 'log' }" @click="activeTab = 'log'">
            Log Event
          </button>
          <button class="tab-btn" :class="{ active: activeTab === 'manage' }" @click="activeTab = 'manage'">
            Manage Events
          </button>
        </div>

        <!-- Tab: Log Event -->
        <div v-show="activeTab === 'log'" class="form-section">

          <b-form @submit.prevent="logEvent">
            <!-- Select Event -->
            <b-form-group label="Select Event">
              <b-form-select v-model="selectedEventId" :options="eventOptions" required>
                <template #first>
                  <b-form-select-option :value="null" disabled>-- Choose Event --</b-form-select-option>
                </template>
              </b-form-select>
            </b-form-group>

            <!-- Show Event Details -->
            <div v-if="selectedEvent"
              style="margin-bottom: 15px; padding: 10px; background: #fff; border: 1px solid #ccc;">
              <div style="font-size: 10px; margin-bottom: 5px;"><strong>TYPE:</strong> {{ selectedEvent.type }}</div>
              <div style="font-size: 10px; margin-bottom: 5px;"><strong>DATA:</strong> {{ selectedEvent.data }}</div>
              <div v-if="selectedEvent.comment" style="font-size: 10px;"><strong>COMMENT:</strong> {{
                selectedEvent.comment }}</div>
            </div>
            <div class="sub-events-section">
              <div class="section-title" style="margin-bottom: 10px;">SUB EVENTS</div>

              <!-- Add Sub Event -->
              <b-form-group label="Add Sub Event">
                <div style="display: flex; gap: 8px;">
                  <b-form-select v-model="tempSubEventId" :options="eventOptions" style="flex: 1;">
                    <template #first>
                      <b-form-select-option :value="null">-- Select Sub Event --</b-form-select-option>
                    </template>
                  </b-form-select>
                  <b-button variant="success" @click="addSubEvent" :disabled="!tempSubEventId"
                    style="width: auto; padding: 6px 12px;">
                    +
                  </b-button>
                </div>
              </b-form-group>

              <!-- List of Sub Events -->
              <div v-if="subEventIds.length > 0" class="sub-events-list">
                <div v-for="eventId in subEventIds" :key="eventId" class="sub-event-item">
                  <div class="sub-event-info">
                    <div style="font-weight: 600; font-size: 11px;">{{ getEventName(eventId) }}</div>
                    <div style="font-size: 9px; color: #666;">{{ getEventType(eventId) }} | {{ getEventData(eventId) }}
                    </div>
                  </div>
                  <b-button variant="danger" size="sm" @click="removeSubEvent(eventId)"
                    style="padding: 2px 8px; font-size: 9px;">Ã—</b-button>
                </div>
              </div>
              <div v-else
                style="padding: 10px; text-align: center; color: #999; font-size: 10px; background: #f9f9f9; border: 1px dashed #ccc;">
                No sub events added
              </div>
            </div>
            <b-row>
              <b-col cols="6">
                <b-form-group label="Side">
                  <b-form-radio-group v-model="logForm.side" :options="sideOptions" required
                    stacked></b-form-radio-group>
                </b-form-group>
              </b-col>
              <b-col>
                <b-form-group label="Result">
                  <b-form-select v-model="logForm.result" :options="resultOptions" required></b-form-select>
                </b-form-group>

              </b-col>
            </b-row>
            <!-- Side Selection -->


            <!-- Result -->

            <!-- Notes -->
            <b-form-group label="Notes (Optional)">
              <b-form-textarea v-model="logForm.notes" rows="3"></b-form-textarea>
            </b-form-group>

            <!-- Sub Events Section -->

            <b-button type="submit" variant="primary" :disabled="!selectedEventId || loading" style="margin-top: 15px;">
              {{ loading ? 'Saving...' : 'Log Event' }}
            </b-button>
          </b-form>
        </div>

        <!-- Tab: Manage Events -->
        <div v-show="activeTab === 'manage'" class="form-section">
          <div class="section-title">CREATE NEW EVENT</div>

          <b-form @submit.prevent="createEvent">
            <b-form-group label="Event Name">
              <b-form-input autocomplete="off" v-model="eventForm.name" required></b-form-input>
            </b-form-group>

            <b-form-group label="Type">
              <b-form-input autocomplete="off" v-model="eventForm.type"
                placeholder="e.g., Pattern, Indicator, Setup"></b-form-input>
            </b-form-group>

            <b-form-group label="Data">
              <b-form-input autocomplete="off" v-model="eventForm.data"
                placeholder="e.g., EMA Cross, RSI Divergence"></b-form-input>
            </b-form-group>

            <b-form-group label="Comment">
              <b-form-textarea autocomplete="off" v-model="eventForm.comment" rows="2"></b-form-textarea>
            </b-form-group>

            <b-button type="submit" variant="primary" :disabled="loading">
              {{ loading ? 'Creating...' : 'Create Event' }}
            </b-button>
          </b-form>

          <div class="section-title" style="margin-top: 20px;">EXISTING EVENTS</div>
          <div style="max-height: 300px; overflow-y: auto;">
            <div v-for="event in events" :key="event.id"
              style="padding: 8px; margin-bottom: 8px; background: #fff; border: 1px solid #ccc; font-size: 11px;">
              <div style="font-weight: 600; margin-bottom: 3px;">{{ event.name }}</div>
              <div style="color: #666;">{{ event.type }} | {{ event.data }}</div>
              <b-button variant="danger" size="sm" @click="deleteEvent(event.id)"
                style="margin-top: 5px; width: auto;">Delete</b-button>
            </div>
          </div>
        </div>

        <!-- Export Actions -->
        <div class="form-actions">
          <div class="section-title">EXPORT</div>
          <div class="action-buttons">
            <b-button variant="secondary" @click="exportJSON" :disabled="logs.length === 0">Export JSON</b-button>
            <b-button variant="secondary" @click="exportCSV" :disabled="logs.length === 0">Export CSV</b-button>
          </div>
        </div>
      </div>

      <!-- Right Panel: Logs Table -->
      <div class="right-panel">
        <div class="table-header">
          <h5>EVENT LOGS: {{ logs.length }}</h5>
          <b-button variant="secondary" size="sm" @click="loadLogs" :disabled="loading"
            style="width: auto; padding: 4px 12px;">
            Refresh
          </b-button>
        </div>

        <div class="table-section">
          <div v-if="logs.length === 0" class="empty-state">
            No event logs yet. Log your first event.
          </div>

          <table v-else class="table table-sm">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Event</th>
                <th>Type</th>
                <th>Data</th>
                <th>Side</th>
                <th>Result</th>
                <th>Notes</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="log in sortedLogs" :key="log.id" @click="openLogDetail(log)" style="cursor: pointer;">
                <td>{{ formatTimestamp(log.created) }}</td>
                <td style="font-weight: 600;">{{ getEventName(log.event_id) }}</td>
                <td>{{ getEventType(log.event_id) }}</td>
                <td>{{ getEventData(log.event_id) }}</td>
                <td :class="log.side === 'long' ? 'side-long' : 'side-short'">
                  {{ log.side.toUpperCase() }}
                </td>
                <td
                  :style="{ color: log.result === 'win' ? '#008000' : log.result === 'loss' ? '#d00' : '#666', fontWeight: '600' }">
                  {{ log.result.toUpperCase() }}
                </td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ log.notes || '-' }}
                </td>
                <td @click.stop>
                  <b-button variant="danger" size="sm" @click="deleteLog(log.id)">Del</b-button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div v-if="loading" class="loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text">{{ overlayMessage }}</div>
      </div>
    </div>

    <!-- Log Detail Modal -->
    <b-modal v-model="showLogDetailModal" title="LOG DETAILS & ADDITIONAL EVENTS" size="lg" hide-footer>
      <div v-if="selectedLog">
        <!-- Main Event Info -->
        <div class="modal-section">
          <h6 class="modal-section-title">MAIN EVENT</h6>
          <div class="event-detail-box">
            <div><strong>Event:</strong> {{ getEventName(selectedLog.event_id) }}</div>
            <div><strong>Type:</strong> {{ getEventType(selectedLog.event_id) }}</div>
            <div><strong>Data:</strong> {{ getEventData(selectedLog.event_id) }}</div>
            <div><strong>Side:</strong> <span :class="selectedLog.side === 'long' ? 'side-long' : 'side-short'">{{
                selectedLog.side.toUpperCase() }}</span></div>
            <div><strong>Result:</strong> <span
                :style="{ color: selectedLog.result === 'win' ? '#008000' : selectedLog.result === 'loss' ? '#d00' : '#666', fontWeight: '600' }">{{
                selectedLog.result.toUpperCase() }}</span></div>
            <div><strong>Notes:</strong> {{ selectedLog.notes || '-' }}</div>
            <div><strong>Time:</strong> {{ formatTimestamp(selectedLog.created) }}</div>
          </div>
        </div>

        <!-- Additional Events -->
        <div class="modal-section">
          <h6 class="modal-section-title">ADDITIONAL EVENTS</h6>

          <!-- Add Event Selector -->
          <b-form-group label="Add Event">
            <div style="display: flex; gap: 8px;">
              <b-form-select v-model="tempEventId" :options="eventOptions" style="flex: 1;">
                <template #first>
                  <b-form-select-option :value="null">-- Select Event to Add --</b-form-select-option>
                </template>
              </b-form-select>
              <b-button variant="primary" @click="addAdditionalEvent(tempEventId); tempEventId = null;"
                :disabled="!tempEventId" style="width: auto;">
                Add
              </b-button>
            </div>
          </b-form-group>

          <!-- List of Additional Events -->
          <div v-if="additionalEventIds.length > 0" class="additional-events-list">
            <div v-for="eventId in additionalEventIds" :key="eventId" class="additional-event-item">
              <div class="additional-event-info">
                <div style="font-weight: 600;">{{ getEventName(eventId) }}</div>
                <div style="font-size: 10px; color: #666;">{{ getEventType(eventId) }} | {{ getEventData(eventId) }}
                </div>
              </div>
              <b-button variant="danger" size="sm" @click="removeAdditionalEvent(eventId)">Remove</b-button>
            </div>
          </div>
          <div v-else style="padding: 20px; text-align: center; color: #999; font-size: 11px;">
            No additional events added yet
          </div>
        </div>

        <!-- Actions -->
        <div style="display: flex; gap: 8px; margin-top: 20px;">
          <b-button variant="primary" @click="saveAdditionalEvents" style="flex: 1;">Save Changes</b-button>
          <b-button variant="secondary" @click="showLogDetailModal = false" style="flex: 1;">Cancel</b-button>
        </div>
      </div>
    </b-modal>
  </div>

  <!-- Vue 2 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.min.js"></script>
  <!-- BootstrapVue -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.js"></script>

  <script src="app.js"></script>
</body>

</html>