<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Screener</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="app">
    <!-- Saving Overlay -->
    <div v-if="isSaving" class="saving-overlay">
      <div class="saving-content">
        <div class="spinner"></div>
        <p>Saving configuration...</p>
        <small>Page will reload automatically</small>
      </div>
    </div>

    <!-- Header -->
    <header class="header">
      <h1>SCREENER</h1>
      <div class="header-actions">
        <button @click="showTasksModal = true" class="btn btn-small btn-primary">TASKS</button>
        <button @click="showSymbolsModal = true" class="btn btn-small">SYMBOLS</button>
        <button @click="showConfigModal = true" class="btn btn-small">CFG</button>
        <button @click="restartApp" class="btn btn-small btn-warning">RESTART</button>
        <button @click="deleteDatabase" class="btn btn-small btn-danger">DELETE DB</button>
        <div class="status-bar">
          <div class="status-item">
            <span class="label">WS:</span>
            <span class="status-badge" :class="wsConnected ? 'connected' : 'disconnected'">
              {{ wsConnected ? 'ON' : 'OFF' }}
            </span>
          </div>
          <div class="status-item">
            <span class="label">EX:</span>
            <span class="status-badge">{{ activeExchanges }}</span>
          </div>
          <div class="status-item">
            <span class="label">SYM:</span>
            <span class="status-badge">{{ totalSymbols }}</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Panel -->
      <div class="left-panel">
        <!-- System Monitor -->
        <div class="panel system-panel">
          <h2>SYSTEM MONITOR</h2>
          <div class="system-grid">
            <div class="system-item" v-for="(value, key) in systemInfo" :key="key">
              <div class="system-label">{{ key }}</div>
              <div class="system-value">{{ value }}</div>
            </div>
          </div>
        </div>

        <!-- Worker Threads -->
        <div class="panel workers-panel">
          <h2>WORKER THREADS</h2>
          <div class="table-wrapper workers-table-wrapper">
            <table class="workers-table">
              <thead>
                <tr>
                  <th class="worker-name">WORKER</th>
                  <th class="worker-metric">CPU</th>
                  <th class="worker-metric">HEAP</th>
                  <th class="worker-status">STATUS</th>
                </tr>
              </thead>
              <tbody>
                <tr v-if="Object.keys(workerMetrics).length === 0">
                  <td colspan="4" class="no-data">WAITING FOR DATA...</td>
                </tr>
                <tr v-for="(worker, name) in workerMetrics" :key="name">
                  <td class="worker-name"><strong>{{ name.toUpperCase() }}</strong></td>
                  <td class="worker-metric">{{ worker.cpuUser }}ms</td>
                  <td class="worker-metric">{{ formatBytes(worker.heapUsed) }}</td>
                  <td class="worker-status">
                    <div v-if="workerProgress[name]" class="worker-progress">
                      <div class="worker-progress-bar">
                        <div 
                          class="worker-progress-fill" 
                          :style="{ width: workerProgress[name].progress + '%' }"
                        ></div>
                      </div>
                      <span class="worker-progress-text">{{ workerProgress[name].progress }}%</span>
                    </div>
                    <span v-else :class="isWorkerAlive(worker) ? 'status-active' : 'status-inactive'">
                      {{ isWorkerAlive(worker) ? '●' : 'X' }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Command Panel -->
        <div class="panel command-panel">
          <h2>COMMAND</h2>
          <div class="command-input-wrapper">
            <input 
              type="text" 
              v-model="commandInput" 
              @keypress.enter="sendCommand"
              placeholder="reload | status | list | clear"
            >
            <button @click="sendCommand" class="btn btn-success">SEND</button>
          </div>
        </div>
      </div>

      <!-- Center Panel -->
      <div class="center-panel">
        <!-- Symbols Panel -->
        <div class="panel symbols-panel">
          <div class="symbols-header">
            <h2>SYMBOLS</h2>
            <input 
              type="text" 
              v-model="symbolsFilter" 
              placeholder="Filter symbols..." 
              class="symbols-filter-input"
            >
          </div>
          <div class="symbols-tabs">
            <button 
              class="symbols-tab-btn" 
              :class="{ active: currentSymbolsTab === 'all' }"
              @click="currentSymbolsTab = 'all'"
            >
              ALL
            </button>
            <button 
              v-for="exchange in Object.keys(dbSymbols)" 
              :key="exchange"
              class="symbols-tab-btn" 
              :class="{ active: currentSymbolsTab === exchange }"
              @click="currentSymbolsTab = exchange"
            >
              {{ exchange.toUpperCase().replace('_', ' ') }}
            </button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>SYMBOL</th>
                  <th>EXCHANGE</th>
                  <th>STATUS</th>
                  <th>TIMEFRAMES</th>
                </tr>
              </thead>
              <tbody>
                <tr v-if="filteredSymbols.length === 0">
                  <td colspan="4" class="no-data">{{ symbolsFilter ? 'No symbols match filter' : 'No symbols in database' }}</td>
                </tr>
                <tr v-for="item in filteredSymbols" :key="`${item.exchange}_${item.symbol}`">
                  <td><strong>{{ item.symbol }}</strong></td>
                  <td><span :class="'exchange-' + item.exchange">{{ item.exchange.toUpperCase().replace('_', ' ') }}</span></td>
                  <td><span class="status-active">● Active</span></td>
                  <td>
                    <div class="timeframe-buttons">
                      <button 
                        class="btn-timeframe btn-ohlcv" 
                        @click="openChart(item.symbol, '1m', item.exchange, 1500)"
                      >
                        OHLCV
                      </button>
                      <button 
                        v-for="tf in ['1m', '5m', '15m', '1h', '4h']" 
                        :key="tf"
                        class="btn-timeframe" 
                        @click="openChart(item.symbol, tf, item.exchange)"
                      >
                        {{ tf }}
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Realtime Data Panel -->
        <div class="panel data-panel">
          <h2>REALTIME DATA</h2>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>EX</th>
                  <th>SYMBOL</th>
                  <th>TF</th>
                  <th>CLOSE</th>
                  <th>VOLUME</th>
                  <th>TIME</th>
                </tr>
              </thead>
              <tbody>
                <tr v-if="realtimeData.length === 0">
                  <td colspan="6" class="no-data">WAITING FOR DATA...</td>
                </tr>
                <tr v-for="item in realtimeData" :key="item.key">
                  <td><span :class="'exchange-' + item.exchange">{{ item.exchange.toUpperCase().replace('_', ' ') }}</span></td>
                  <td><strong>{{ item.symbol }}</strong></td>
                  <td>{{ item.interval }}</td>
                  <td :class="['price-close', item.flashClass]">
                    {{ item.status }} {{ item.close }}
                  </td>
                  <td>{{ item.volume }}</td>
                  <td>{{ item.time }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Right Panel -->
      <div class="right-panel">
        <div class="panel terminal-panel">
          <div class="terminal-header">
            <h2>TERMINAL LOG</h2>
            <button @click="clearLogs" class="btn btn-small">CLEAR</button>
          </div>
          <div class="terminal-content">
            <div 
              v-for="(log, index) in logs" 
              :key="index"
              class="log-entry" 
              :class="`log-${log.type}`"
            >
              <span class="log-time">[{{ log.time }}]</span>
              <span class="log-message">{{ log.message }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Config Modal -->
    <div v-if="showConfigModal" class="modal show" @click.self="showConfigModal = false">
      <div class="modal-content modal-large">
        <!-- Saving Overlay for Config -->
        <div v-if="isSavingConfig" class="saving-overlay">
          <div class="saving-content">
            <div class="spinner"></div>
            <p>Saving configuration...</p>
            <small v-if="configTab === 'server'">Server will restart automatically</small>
            <small v-else>Applying settings...</small>
          </div>
        </div>

        <div class="modal-header">
          <h3>CONFIGURATION</h3>
          <button class="modal-close" @click="showConfigModal = false">×</button>
        </div>

        <div class="tabs">
          <button 
            class="tab-btn" 
            :class="{ active: configTab === 'client' }"
            @click="configTab = 'client'"
          >
            CLIENT SETTINGS
          </button>
          <button 
            class="tab-btn" 
            :class="{ active: configTab === 'server' }"
            @click="configTab = 'server'"
          >
            SERVER SETTINGS
          </button>
        </div>

        <div class="tab-content">
          <!-- Client Settings Tab -->
          <div v-if="configTab === 'client'" class="config-tab-panel">
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" v-model="config.realtime_update">
                <span>Enable Realtime Price Updates</span>
              </label>
              <small>Update prices and render in realtime (may impact performance)</small>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" v-model="config.debug_log">
                <span>Enable Debug Logs</span>
              </label>
              <small>Show detailed debug logs (max 200 lines)</small>
            </div>
            <div class="form-group">
              <label>Max Log Lines:</label>
              <input type="number" v-model.number="config.max_log_lines" min="50" max="1000" step="50">
              <small>Maximum number of log lines to keep (default: 200)</small>
            </div>
            <div class="form-group">
              <button @click="saveClientConfig" class="btn btn-success">SAVE CLIENT SETTINGS</button>
            </div>
          </div>

          <!-- Server Settings Tab -->
          <div v-if="configTab === 'server'" class="config-tab-panel">
            <div class="form-group">
              <label>Batch Interval (ms):</label>
              <input type="number" v-model.number="config.batch_interval" min="1000" step="1000">
              <small>Time between database writes (default: 60000ms = 1 minute)</small>
            </div>
            <div class="form-group">
              <label>Max Records:</label>
              <input type="number" v-model.number="config.max_records" min="1000" step="1000">
              <small>Maximum candles to keep per symbol (default: 200000)</small>
            </div>
            <div class="form-group">
              <label>Bootstrap Load:</label>
              <input type="number" v-model.number="config.bootstrap_load" min="100" step="100">
              <small>Initial candles to load on startup (default: 50000)</small>
            </div>
            <div class="form-group">
              <label>Cleanup Hour:</label>
              <input type="number" v-model.number="config.cleanup_hour" min="0" max="23">
              <small>Hour to run daily cleanup (0-23, default: 3 = 3:00 AM)</small>
            </div>
            <div class="form-group">
              <label>Server Port:</label>
              <input type="number" v-model.number="config.port" min="1000" max="65535">
              <small>HTTP server port (requires restart)</small>
            </div>
            <div class="form-group">
              <button @click="saveConfig" class="btn btn-primary">SAVE & RESTART</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- OHLCV Modal -->
    <div v-if="showOHLCVModal" class="modal show" @click.self="showOHLCVModal = false">
      <div class="modal-content modal-ohlcv">
        <div class="modal-header">
          <h3>OHLCV DATA</h3>
          <button class="modal-close" @click="showOHLCVModal = false">×</button>
        </div>
        <div class="modal-iframe-container">
          <iframe :src="ohlcvIframeSrc" frameborder="0"></iframe>
        </div>
      </div>
    </div>

    <!-- Tasks Modal -->
    <div v-if="showTasksModal" class="modal show" @click.self="showTasksModal = false">
      <div class="modal-content">
        <div class="modal-header">
          <h3>ACTIVE TASKS</h3>
          <button class="modal-close" @click="showTasksModal = false">×</button>
        </div>
        <div class="tasks-container">
          <div v-if="Object.keys(workerProgress).length === 0" class="no-tasks">
            <p>No active tasks</p>
          </div>
          <div v-else class="tasks-list">
            <div v-for="(task, exchange) in workerProgress" :key="exchange" class="task-item">
              <div class="task-header">
                <h4>{{ exchange.toUpperCase().replace('_', ' ') }}</h4>
                <span class="task-status">{{ task.status }}</span>
              </div>
              <p class="task-message">{{ task.message }}</p>
              <div class="task-progress-bar">
                <div class="task-progress-fill" :style="{ width: task.progress + '%' }"></div>
              </div>
              <p class="task-progress-text">{{ task.progress }}%</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Symbols Manager Modal -->
    <div v-if="showSymbolsModal" class="modal show" @click.self="showSymbolsModal = false">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h3>SYMBOLS MANAGER</h3>
          <button class="modal-close" @click="showSymbolsModal = false">×</button>
        </div>

        <div class="tabs">
          <button 
            v-for="ex in ['binance_futures', 'bybit_futures', 'okx_futures']" 
            :key="ex"
            class="tab-btn" 
            :class="{ active: currentExchange === ex }"
            @click="switchExchange(ex)"
          >
            {{ ex.toUpperCase().replace('_', ' ') }}
            <span 
              class="exchange-status" 
              :class="exchangesConfig[ex]?.enabled ? 'status-enabled' : 'status-disabled'"
            >
              {{ exchangesConfig[ex]?.enabled ? '●' : '○' }}
            </span>
          </button>
        </div>

        <div class="tab-content">
          <!-- Loading Overlay for Exchange Switch -->
          <div v-if="isLoadingExchange" class="exchange-loading-overlay">
            <div class="exchange-loading-spinner">
              <div class="spinner"></div>
              <p>Loading {{ currentExchange.toUpperCase().replace('_', ' ') }}...</p>
            </div>
          </div>

          <div class="exchange-controls">
            <button @click="toggleExchange" class="btn btn-small btn-warning">
              TOGGLE ENABLE/DISABLE
            </button>
            <span 
              class="status-badge" 
              :class="exchangesConfig[currentExchange]?.enabled ? 'connected' : 'disconnected'"
            >
              {{ exchangesConfig[currentExchange]?.enabled ? 'ENABLED' : 'DISABLED' }}
            </span>
          </div>
          
          <div class="symbols-manager">
            <!-- Whitelist -->
            <div class="symbols-section">
              <div class="section-header">
                <h4>WHITELIST ({{ filteredWhitelist.length }})</h4>
                <button @click="saveWhitelist" class="btn btn-success btn-small">SAVE</button>
              </div>
              <div class="symbols-search">
                <input type="text" v-model="whitelistSearch" placeholder="Search whitelist...">
              </div>
              <div class="symbols-list">
                <div v-if="filteredWhitelist.length === 0" class="loading-symbols">
                  No symbols in whitelist
                </div>
                <div 
                  v-for="symbol in filteredWhitelist" 
                  :key="symbol"
                  class="symbol-item"
                >
                  <span class="symbol-name">{{ symbol }}</span>
                  <button class="symbol-action remove" @click="removeFromWhitelist(symbol)">
                    REMOVE
                  </button>
                </div>
              </div>
            </div>

            <!-- Available Symbols -->
            <div class="symbols-section">
              <div class="section-header">
                <h4>AVAILABLE SYMBOLS ({{ filteredAvailable.length }})</h4>
                <button @click="loadAvailableSymbols" class="btn btn-small">REFRESH</button>
              </div>
              <div class="symbols-search">
                <input type="text" v-model="availableSearch" placeholder="Search symbols...">
              </div>
              <div class="symbols-list">
                <div v-if="availableSymbols.length === 0" class="loading-symbols">
                  Loading symbols...
                </div>
                <div v-else-if="filteredAvailable.length === 0" class="loading-symbols">
                  All symbols added to whitelist
                </div>
                <div 
                  v-for="item in filteredAvailable" 
                  :key="item.symbol"
                  class="symbol-item"
                >
                  <div class="symbol-info">
                    <span class="symbol-name">{{ item.symbol }}</span>
                    <span v-if="item.volumeFormatted" class="symbol-volume">
                      Vol: {{ item.volumeFormatted }}
                    </span>
                  </div>
                  <button class="symbol-action" @click="addToWhitelist(item.symbol)">
                    ADD
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load dependencies first -->
  <script src="js/vue.global.prod.js"></script>
  <script src="js/ccxt.browser.min.js"></script>
  
  <!-- Load app as module -->
  <script type="module" src="js/app.js"></script>
</body>
</html>
